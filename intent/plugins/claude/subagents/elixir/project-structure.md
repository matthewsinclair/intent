# Phoenix/Ash Project Structure Reference

Standard directory layout for Phoenix applications using Ash Framework.

## Top-Level Structure

```
my_app/
├── lib/
│   ├── my_app/              # Domain layer (business logic)
│   ├── my_app_web/          # Web layer (presentation)
│   └── my_app.ex            # Application module
├── test/
│   ├── my_app/              # Domain tests
│   ├── my_app_web/          # Web tests
│   ├── support/             # Test helpers, fixtures, mocks
│   └── test_helper.exs      # Test configuration
├── priv/
│   ├── repo/migrations/     # Ecto migrations (generated by mix ash.codegen)
│   ├── static/              # Static assets (favicon, robots.txt)
│   └── gettext/             # Internationalization
├── assets/                  # Frontend assets (JS, CSS, Tailwind)
├── config/                  # Configuration files
│   ├── config.exs           # Shared config
│   ├── dev.exs              # Dev environment
│   ├── test.exs             # Test environment
│   ├── prod.exs             # Prod compile-time config
│   └── runtime.exs          # Prod runtime config (env vars)
├── deps/                    # Dependencies (gitignored)
├── mix.exs                  # Project definition and dependencies
├── mix.lock                 # Locked dependency versions
└── .formatter.exs           # Code formatter configuration
```

## Domain Layer (`lib/my_app/`)

The domain layer contains all business logic, organized by bounded contexts (Ash domains).

```
lib/my_app/
├── my_app.ex                # Application module (supervision tree)
├── repo.ex                  # Ecto Repo module
│
├── accounts/                # Domain: Accounts
│   ├── accounts.ex          # Ash Domain module (code interfaces)
│   ├── user.ex              # Ash Resource
│   ├── token.ex             # Ash Resource
│   ├── changes/             # Custom Ash changes
│   │   └── hash_password.ex
│   ├── validations/         # Custom Ash validations
│   │   └── email_format.ex
│   └── preparations/        # Custom Ash preparations
│       └── filter_active.ex
│
├── content/                 # Domain: Content
│   ├── content.ex           # Ash Domain module
│   ├── post.ex              # Ash Resource
│   ├── comment.ex           # Ash Resource
│   └── changes/
│       └── slugify_title.ex
│
└── notifications/           # Domain: Notifications
    ├── notifications.ex     # Ash Domain module
    ├── notifiers/           # Ash Notifiers
    │   ├── email_notifier.ex
    │   └── webhook_notifier.ex
    └── workers/             # Oban workers
        └── send_email_worker.ex
```

### Domain Organization Rules

- **One directory per domain** -- each bounded context gets its own directory
- **Domain module at root** -- `accounts.ex` defines the Ash Domain with code interfaces
- **Resources as files** -- each Ash resource is a single file in the domain directory
- **Subdirectories for customizations** -- `changes/`, `validations/`, `preparations/` for custom modules
- **Never cross-reference internals** -- other domains call through the domain module's code interfaces

## Web Layer (`lib/my_app_web/`)

The web layer handles HTTP, LiveView, and API presentation.

```
lib/my_app_web/
├── my_app_web.ex            # Web module (controller/live_view/component macros)
├── endpoint.ex              # Phoenix Endpoint
├── router.ex                # Route definitions
├── gettext.ex               # Gettext module
│
├── controllers/             # Traditional controllers
│   ├── page_controller.ex
│   ├── page_html.ex         # HTML module for page controller
│   ├── page_html/           # Templates for page controller
│   │   └── home.html.heex
│   ├── auth_controller.ex   # phx.gen.auth controller
│   └── error_json.ex        # JSON error rendering
│
├── live/                    # LiveView modules
│   ├── post_live/
│   │   ├── index.ex         # List view
│   │   ├── show.ex          # Detail view
│   │   ├── form_component.ex # Form as component
│   │   └── index.html.heex  # Colocated template
│   └── user_live/
│       ├── settings.ex
│       └── settings.html.heex
│
├── components/              # Reusable components
│   ├── core_components.ex   # Phoenix-generated core components
│   ├── layouts.ex           # Layout components
│   ├── layouts/
│   │   ├── app.html.heex    # Main app layout
│   │   └── root.html.heex   # Root HTML layout
│   └── ui/                  # Custom UI components
│       ├── badge.ex
│       └── card.ex
│
└── plugs/                   # Custom plugs
    └── require_admin.ex
```

### Web Layer Organization Rules

- **LiveViews grouped by resource** -- `post_live/` contains all post-related LiveViews
- **Colocated templates** -- `.html.heex` files live next to their module
- **Components namespace** -- reusable components under `components/`
- **No business logic** -- web modules are coordinators only (Thin Controllers principle)

## Test Directory (`test/`)

Tests mirror the source structure.

```
test/
├── test_helper.exs          # ExUnit config, sandbox setup
│
├── my_app/                  # Domain tests
│   ├── accounts/
│   │   ├── accounts_test.exs    # Domain code interface tests
│   │   └── user_test.exs        # Resource-specific tests
│   └── content/
│       └── content_test.exs
│
├── my_app_web/              # Web tests
│   ├── controllers/
│   │   └── page_controller_test.exs
│   └── live/
│       └── post_live_test.exs
│
└── support/                 # Test support
    ├── conn_case.ex         # ConnCase for controller/LiveView tests
    ├── data_case.ex         # DataCase for domain tests
    ├── fixtures/            # Test data factories
    │   ├── accounts_fixtures.ex
    │   └── content_fixtures.ex
    └── mocks/               # Mox mock definitions
        └── mocks.ex
```

## Configuration (`config/`)

```
config/
├── config.exs       # Shared across all environments
├── dev.exs          # Local development (database, debug)
├── test.exs         # Test environment (sandbox, async)
├── prod.exs         # Production compile-time (logger level)
└── runtime.exs      # Production runtime (env vars: DATABASE_URL, SECRET_KEY_BASE)
```

### Configuration Rules

- **Never hardcode secrets** -- all secrets go in `runtime.exs` via `System.get_env/1`
- **`config.exs` for shared settings** -- Ecto repos, endpoint config, logger
- **`runtime.exs` for production** -- database URLs, API keys, host names
- **Test config sets `async: true`** -- Ecto sandbox mode for concurrent tests

## Where New Code Goes (Decision Tree)

| What you're adding        | Where it goes                                |
| ------------------------- | -------------------------------------------- |
| New business domain       | `lib/my_app/<domain>/`                       |
| New Ash resource          | `lib/my_app/<domain>/<resource>.ex`          |
| Custom Ash change         | `lib/my_app/<domain>/changes/<name>.ex`      |
| Custom Ash validation     | `lib/my_app/<domain>/validations/<name>.ex`  |
| Custom Ash preparation    | `lib/my_app/<domain>/preparations/<name>.ex` |
| Ash notifier              | `lib/my_app/<domain>/notifiers/<name>.ex`    |
| Background job            | `lib/my_app/<domain>/workers/<name>.ex`      |
| New LiveView              | `lib/my_app_web/live/<resource>_live/`       |
| New controller            | `lib/my_app_web/controllers/`                |
| Reusable UI component     | `lib/my_app_web/components/ui/`              |
| Domain-specific component | `lib/my_app_web/components/<domain>/`        |
| Custom plug               | `lib/my_app_web/plugs/`                      |
| Migration                 | `mix ash.codegen <name>` (auto-generated)    |
| Domain test               | `test/my_app/<domain>/`                      |
| Web test                  | `test/my_app_web/`                           |
| Test fixture              | `test/support/fixtures/`                     |
| Mock definition           | `test/support/mocks/`                        |

## Ash-Specific Files

Files commonly found in Ash projects:

| File                                    | Purpose                                           |
| --------------------------------------- | ------------------------------------------------- |
| `lib/my_app/<domain>/<domain>.ex`       | Ash Domain (code interfaces, policies)            |
| `lib/my_app/<domain>/<resource>.ex`     | Ash Resource (attributes, actions, relationships) |
| `lib/my_app/<domain>/registry.ex`       | Resource registry (if not using Domain)           |
| `lib/my_app/<domain>/changes/*.ex`      | Custom change modules                             |
| `lib/my_app/<domain>/calculations/*.ex` | Custom calculation modules                        |
| `lib/my_app/repo.ex`                    | AshPostgres.Repo (extends Ecto.Repo)              |
| `.formatter.exs`                        | Must include Ash formatter plugins                |

### Formatter Configuration for Ash

```elixir
# .formatter.exs
[
  import_deps: [:ash, :ash_postgres, :ash_phoenix],
  plugins: [Ash.DSL.Formatter, Phoenix.LiveView.HTMLFormatter],
  inputs: ["*.{heex,ex,exs}", "{config,lib,test}/**/*.{heex,ex,exs}"]
]
```
