#!/bin/bash
# intent_claude_subagents - Manage Claude Code subagents for Intent projects
# Copyright (c) 2026 Matthew Sinclair
# Licensed under the MIT License (see LICENSE file)
# Commands: list, install, sync, uninstall, show, status

# Source helpers from main bin directory
PLUGIN_BIN="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INTENT_ROOT="$(cd "$PLUGIN_BIN/../../../.." && pwd)"
INTENT_BIN="$INTENT_ROOT/bin"
source "$INTENT_BIN/intent_helpers"

# ---- Plugin callbacks ----

PLUGIN_TYPE="agent"
PLUGIN_TYPE_CAP="Agent"
PLUGIN_TYPE_PLURAL="agents"
PLUGIN_CMD="subagents"

plugin_get_manifest_path() {
  if [ -n "${PROJECT_ROOT:-}" ]; then
    echo "$PROJECT_ROOT/intent/plugins/claude/subagents/.manifest/installed-agents.json"
  else
    echo "$HOME/.intent/agents/installed-agents.json"
  fi
}

plugin_get_source_file() {
  echo "$INTENT_HOME/intent/plugins/claude/subagents/$1/agent.md"
}

plugin_is_installed() {
  [ -f "$HOME/.claude/agents/$1.md" ]
}

plugin_copy_to_target() {
  mkdir -p "$HOME/.claude/agents" && cp "$(plugin_get_source_file "$1")" "$HOME/.claude/agents/$1.md"
}

plugin_remove_target() {
  rm -f "$HOME/.claude/agents/$1.md"
}

plugin_checksum_target() {
  calculate_checksum "$HOME/.claude/agents/$1.md"
}

plugin_get_available_names() {
  local m="$INTENT_HOME/intent/plugins/claude/subagents/.manifest/global-agents.json"
  [ -f "$m" ] && jq -r '.agents[].name' "$m" 2>/dev/null
}

plugin_manifest_extra() {
  echo '"source": "global"'
}

# Source shared plugin logic (install, sync, uninstall, manifest ops)
source "$PLUGIN_BIN/../lib/claude_plugin_helpers.sh"

# ---- Agent-specific functions ----

# Show help
intent_claude_subagents_help() {
  cat << EOF
Usage: intent claude subagents <command> [options]

Manage Claude Code subagents for Intent projects.

Commands:
  init        Initialize agent configuration
  list        List available and installed agents (-v for details)
  install     Install agent(s) to Claude configuration
  sync        Sync installed agents with latest versions
  uninstall   Remove Intent-managed agents
  show        Display detailed agent information
  status      Check agent health and integrity

Examples:
  intent claude subagents init              # Initialize subagent configuration
  intent claude subagents list              # Show all subagents
  intent claude subagents list -v           # Show full descriptions
  intent claude subagents install intent    # Install the Intent subagent
  intent claude subagents install --all     # Install all available subagents
  intent claude subagents sync              # Update modified subagents

For help on a specific command:
  intent help claude subagents <command>
EOF
}

# Initialize subagent configuration
intent_claude_subagents_init() {
  echo "Initializing Claude subagent configuration..."

  # Check for project or global init
  local init_type="global"
  local force=false

  for arg in "$@"; do
    if [ "$arg" = "--project" ] || [ "$arg" = "-p" ]; then
      init_type="project"
    elif [ "$arg" = "--force" ] || [ "$arg" = "-f" ]; then
      force=true
    fi
  done

  # Initialize based on type
  if [ "$init_type" = "project" ]; then
    # Project-level initialization
    if [ -z "${PROJECT_ROOT:-}" ]; then
      echo "Error: Not in an Intent project directory"
      echo "Use 'intent claude subagents init' without --project for global initialization"
      return 1
    fi

    echo "Initializing project agent configuration..."

    # Initialize project agent tracking in the correct location
    mkdir -p "$PROJECT_ROOT/intent/plugins/claude/subagents/.manifest"
    if [ ! -f "$PROJECT_ROOT/intent/plugins/claude/subagents/.manifest/installed-agents.json" ]; then
      echo "  Creating project agent manifest..."
      cat > "$PROJECT_ROOT/intent/plugins/claude/subagents/.manifest/installed-agents.json" << 'EOF'
{
  "version": "1.0.0",
  "installed": []
}
EOF
    elif [ "$force" = false ]; then
      echo "  Project agent manifest already exists (use --force to overwrite)"
    fi

    echo "Project agent configuration initialized successfully"
  else
    # Global initialization
    echo "Initializing global agent configuration..."

    # Create user agent directory
    local user_agent_dir="$HOME/.intent/agents"
    mkdir -p "$user_agent_dir"

    # Create user installed agents manifest
    if [ ! -f "$user_agent_dir/installed-agents.json" ] || [ "$force" = true ]; then
      echo "  Creating user agent manifest..."
      cat > "$user_agent_dir/installed-agents.json" << 'EOF'
{
  "version": "1.0.0",
  "installed": []
}
EOF
    else
      echo "  User agent manifest already exists (use --force to recreate)"
    fi

    # Check global Intent installation
    if [ -n "$INTENT_HOME" ] && [ -d "$INTENT_HOME/intent/plugins/claude/subagents" ]; then
      # Ensure global agent manifest exists
      if [ ! -f "$INTENT_HOME/intent/plugins/claude/subagents/.manifest/global-agents.json" ]; then
        echo "  Warning: Global agent manifest missing at $INTENT_HOME/intent/plugins/claude/subagents/.manifest/"
        echo "  This may indicate an incomplete Intent installation"
      else
        if command -v jq >/dev/null 2>&1; then
          local agent_count=$(jq -r '.agents | length' "$INTENT_HOME/intent/plugins/claude/subagents/.manifest/global-agents.json" 2>/dev/null || echo 0)
          echo "  Found $agent_count available agents in Intent installation"
        else
          echo "  Warning: jq not installed - cannot read agent manifest"
          echo "  Install jq to enable agent management: brew install jq (macOS) or apt-get install jq (Linux)"
        fi
      fi
    else
      echo "  Warning: INTENT_HOME not set or agents directory not found"
      echo "  Some agent features may not work correctly"
    fi

    # Check for Claude Code
    if [ -d "$HOME/.claude" ]; then
      echo "  Claude Code detected at $HOME/.claude"
      mkdir -p "$HOME/.claude/agents"
    else
      echo "  Note: Claude Code not detected"
      echo "  Install Claude Code to use agents: https://claude.ai/download"
    fi

    echo ""
    echo "Global agent configuration initialized successfully"
    echo ""
    echo "Next steps:"
    echo "  intent agents list        # See available agents"
    echo "  intent agents install <agent>  # Install an agent"
  fi
}

# Helper: Read agent info from manifest
get_agent_info() {
  local manifest="$1"
  local agent_name="$2"

  if [ -f "$manifest" ]; then
    if command -v jq >/dev/null 2>&1; then
      jq -r ".agents[] | select(.name == \"$agent_name\")" "$manifest" 2>/dev/null
    else
      echo "Error: jq is required for agent operations but not installed" >&2
      return 1
    fi
  fi
}

# List available and installed agents
intent_claude_subagents_list() {
  echo "Available Agents:"
  echo ""

  local term_width
  term_width=$(get_terminal_width)

  # Layout: "  " (2) + agent name (12) + " - " (3) = 17 left
  local desc_width=$(( term_width - 17 - 16 ))
  [ "$desc_width" -lt 20 ] && desc_width=20

  # Parse --verbose flag
  local verbose=false
  local args=()
  while [ $# -gt 0 ]; do
    case "$1" in
      -v|--verbose) verbose=true; shift ;;
      *) args+=("$1"); shift ;;
    esac
  done
  set -- "${args[@]}"

  # Global agents
  local global_manifest="$INTENT_HOME/intent/plugins/claude/subagents/.manifest/global-agents.json"
  if [ -f "$global_manifest" ]; then
    echo "Global:"

    require_jq || return 1

    # Read agent names from manifest
    local agents=$(jq -r '.agents[].name' "$global_manifest" 2>/dev/null)

    for agent in $agents; do
      local info=$(jq -r ".agents[] | select(.name == \"$agent\") | .description" "$global_manifest" 2>/dev/null || echo "<unable to read description>")
      local status=""

      if plugin_is_installed "$agent"; then
        status="[INSTALLED]"
      else
        status="[NOT INSTALLED]"
      fi

      if [ "$verbose" = true ]; then
        local left pad
        left="$(printf '%-12s' "$agent")"
        pad=$(( term_width - 2 - ${#left} - ${#status} ))
        [ "$pad" -lt 1 ] && pad=1
        printf "  %s%*s%s\n" "$left" "$pad" "" "$status"
        printf "    %s\n\n" "$info"
      else
        local description left pad
        if [ ${#info} -le $desc_width ]; then
          description="$info"
        else
          description="${info:0:$((desc_width - 3))}"
          description="${description% *}..."
        fi
        left="$(printf '%-12s' "$agent") - $description"
        pad=$(( term_width - 2 - ${#left} - ${#status} ))
        [ "$pad" -lt 1 ] && pad=1
        printf "  %s%*s%s\n" "$left" "$pad" "" "$status"
      fi
    done
  else
    echo "  No global agents found"
  fi

  echo ""

  # Local agents (if in project)
  if [ -n "${PROJECT_ROOT:-}" ] && [ -d "$PROJECT_ROOT/intent/agents" ]; then
    local local_manifest="$PROJECT_ROOT/intent/plugins/claude/subagents/.manifest/installed-agents.json"
    if [ -f "$local_manifest" ]; then
      echo "Local (Project-specific):"
      # TODO: Implement local agent listing
      echo "  Local agent support coming soon"
    fi
  fi

  # Check for Claude installation
  if [ ! -d "$HOME/.claude" ]; then
    echo ""
    echo "Note: Claude Code not detected. Install Claude Code to use agents."
  fi
}

# Check status of installed agents
intent_claude_subagents_status() {
  # Parse flags
  local VERBOSE=false
  for arg in "$@"; do
    if [ "$arg" = "--verbose" ] || [ "$arg" = "-v" ]; then
      VERBOSE=true
    fi
  done

  # Color codes (if terminal)
  if [ -t 1 ]; then
    RED='\033[0;31m'
    YELLOW='\033[0;33m'
    GREEN='\033[0;32m'
    NC='\033[0m' # No Color
  else
    RED=''
    YELLOW=''
    GREEN=''
    NC=''
  fi

  require_claude || return 1

  # Determine manifest location
  local manifest_file
  manifest_file="$(plugin_get_manifest_path)"

  # Check if any agents are installed
  if [ ! -f "$manifest_file" ]; then
    echo "No installed agents found."
    echo "Use 'intent claude subagents install' to install agents."
    return 0
  fi

  echo "Checking agent status..."
  echo ""

  # Read installed agents
  local agents=$(jq -r '.installed[].name' "$manifest_file" 2>/dev/null)
  if [ -z "$agents" ]; then
    echo "No agents found in manifest."
    return 0
  fi

  # Counters
  local total=0
  local ok_count=0
  local modified_count=0
  local missing_count=0
  local error_count=0

  # Check each agent
  for agent in $agents; do
    ((total++))

    # Get agent info from manifest
    local agent_info=$(jq -r ".installed[] | select(.name == \"$agent\")" "$manifest_file")
    local source=$(echo "$agent_info" | jq -r '.source')
    local source_path=$(echo "$agent_info" | jq -r '.source_path')
    local manifest_checksum=$(echo "$agent_info" | jq -r '.checksum')
    local installed_at=$(echo "$agent_info" | jq -r '.installed_at // "Unknown"')

    # Check installed file
    local installed_file="$HOME/.claude/agents/${agent}.md"
    local status="OK"
    local status_color="${GREEN}"
    local details=""

    if [ ! -f "$installed_file" ]; then
      status="MISSING"
      status_color="${RED}"
      details="Agent file not found"
      ((missing_count++))
    else
      # Calculate current checksum
      local current_checksum=$(calculate_checksum "$installed_file")

      # Check source file
      local source_file
      if [ "$source" = "global" ]; then
        source_file="$source_path/agent.md"
      else
        source_file="$source_path/agent.md"
      fi

      if [ ! -f "$source_file" ]; then
        status="ERROR"
        status_color="${RED}"
        details="Source file missing: $source_file"
        ((error_count++))
      elif [ "$current_checksum" != "$manifest_checksum" ]; then
        # Check if it matches source (user might have synced manually)
        local source_checksum=$(calculate_checksum "$source_file")
        if [ "$current_checksum" = "$source_checksum" ]; then
          status="UPDATED"
          status_color="${YELLOW}"
          details="Synced but manifest outdated"
          ((modified_count++))
        else
          status="MODIFIED"
          status_color="${YELLOW}"
          details="Local changes detected"
          ((modified_count++))
        fi
      else
        # Check if source has updates
        local source_checksum=$(calculate_checksum "$source_file")
        if [ "$source_checksum" != "$manifest_checksum" ]; then
          status="UPDATE"
          status_color="${YELLOW}"
          details="Update available"
          ((modified_count++))
        else
          ((ok_count++))
        fi
      fi
    fi

    # Display status
    printf "%-15s " "$agent"
    printf "${status_color}%-10s${NC}" "[$status]"
    if [ -n "$details" ]; then
      echo " - $details"
    else
      echo ""
    fi

    # Verbose details
    if [ "$VERBOSE" = true ]; then
      echo "  Source: $source"
      echo "  Installed: $installed_at"
      if [ "$status" != "MISSING" ] && [ "$status" != "ERROR" ]; then
        echo "  Location: $installed_file"
      fi
      echo ""
    fi
  done

  # Summary
  echo ""
  echo "Summary:"
  echo "  Total: $total"
  [ $ok_count -gt 0 ] && echo "  OK: $ok_count"
  [ $modified_count -gt 0 ] && echo "  Modified/Updates: $modified_count"
  [ $missing_count -gt 0 ] && echo "  Missing: $missing_count"
  [ $error_count -gt 0 ] && echo "  Errors: $error_count"

  # Recommendations
  if [ $missing_count -gt 0 ] || [ $error_count -gt 0 ]; then
    echo ""
    echo "Recommendations:"
    if [ $missing_count -gt 0 ]; then
      echo "  - Run 'intent claude subagents install' to restore missing agents"
    fi
    if [ $error_count -gt 0 ]; then
      echo "  - Check error details above and reinstall affected agents"
    fi
  elif [ $modified_count -gt 0 ]; then
    echo ""
    echo "Run 'intent claude subagents sync' to update agents with available changes."
  fi

  # Return non-zero if issues found
  if [ $missing_count -gt 0 ] || [ $error_count -gt 0 ]; then
    return 1
  else
    return 0
  fi
}

# Show detailed agent information
intent_claude_subagents_show() {
  require_jq || return 1

  if [ "$#" -eq 0 ]; then
    echo "Error: Agent name required"
    echo "Usage: intent claude subagents show <agent-name>"
    return 1
  fi

  local agent_name="$1"

  # Check global agents first
  local global_manifest="$INTENT_HOME/intent/plugins/claude/subagents/.manifest/global-agents.json"
  local agent_info=""
  local source_type=""
  local source_path=""

  if [ -f "$global_manifest" ]; then
    agent_info=$(jq -r ".agents[] | select(.name == \"$agent_name\")" "$global_manifest" 2>/dev/null)
    if [ -n "$agent_info" ]; then
      source_type="global"
      source_path="$INTENT_HOME/intent/plugins/claude/subagents/$agent_name"
    fi
  fi

  if [ -z "$agent_info" ]; then
    echo "Error: Agent '$agent_name' not found"
    return 1
  fi

  # Parse agent info
  local version=$(echo "$agent_info" | jq -r '.version // "unknown"')
  local description=$(echo "$agent_info" | jq -r '.description // "No description"')

  # Check if installed
  local status="NOT INSTALLED"
  local installed_path=""
  if plugin_is_installed "$agent_name"; then
    status="INSTALLED"
    installed_path="$HOME/.claude/agents/${agent_name}.md"
  fi

  # Read metadata if available
  local metadata_file="$source_path/metadata.json"
  local tools="Not specified"
  local tags="None"
  local author="Unknown"

  if [ -f "$metadata_file" ]; then
    local metadata=$(cat "$metadata_file")
    tools=$(echo "$metadata" | jq -r '.tools[]?' 2>/dev/null | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g' || echo "Not specified")
    tags=$(echo "$metadata" | jq -r '.tags[]?' 2>/dev/null | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g' || echo "None")
    author=$(echo "$metadata" | jq -r '.author // "Unknown"' 2>/dev/null)
  fi

  # Display agent information
  echo "Agent: $agent_name"
  echo "Version: $version"
  echo "Description: $description"
  echo "Status: $status"
  echo "Source: $source_type"
  echo "Author: $author"
  echo ""
  echo "Tools: $tools"
  echo "Tags: $tags"

  # Show installation info if installed
  if [ "$status" = "INSTALLED" ]; then
    local manifest_file
    manifest_file="$(plugin_get_manifest_path)"

    if [ -f "$manifest_file" ]; then
      local installed_info=$(jq -r ".installed[] | select(.name == \"$agent_name\")" "$manifest_file" 2>/dev/null)
      if [ -n "$installed_info" ]; then
        local installed_at=$(echo "$installed_info" | jq -r '.installed_at // "Unknown"')
        local modified=$(echo "$installed_info" | jq -r '.modified // false')
        echo ""
        echo "Installed: $installed_at"
        if [ "$modified" = "true" ]; then
          echo "Modified: Yes (local changes present)"
        fi
      fi
    fi
  fi

  # Show content preview
  local agent_file="$source_path/agent.md"
  if [ -f "$agent_file" ]; then
    echo ""
    echo "System Prompt Preview:"
    echo "---"
    # Skip YAML frontmatter and show first 10 lines of content
    awk 'BEGIN{fm=0} /^---$/{fm++; next} fm==2{lines++; print} lines>=10{exit}' "$agent_file"
    echo "---"
    echo ""
    if [ "$status" = "INSTALLED" ]; then
      echo "Full content: $installed_path"
    else
      echo "To install: intent agents install $agent_name"
    fi
  else
    echo ""
    echo "Error: Agent file not found at $agent_file"
  fi
}

# Route commands - only run if script is executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  case "$1" in
    init)
      shift
      intent_claude_subagents_init "$@"
      ;;
    list)
      shift
      intent_claude_subagents_list "$@"
      ;;
    install)
      shift
      plugin_install "$@"
      ;;
    sync)
      shift
      plugin_sync "$@"
      ;;
    uninstall)
      shift
      plugin_uninstall "$@"
      ;;
    show)
      shift
      intent_claude_subagents_show "$@"
      ;;
    status)
      shift
      intent_claude_subagents_status "$@"
      ;;
    ""|help|-h|--help)
      intent_claude_subagents_help
      ;;
    *)
      echo "Error: Unknown command 'intent claude subagents $1'"
      echo "Run 'intent claude subagents help' for usage"
      exit 1
      ;;
  esac
fi
