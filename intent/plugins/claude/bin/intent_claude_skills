#!/bin/bash
# intent_claude_skills - Manage Claude Code skills for Intent projects
# Copyright (c) 2026 Matthew Sinclair
# Licensed under the MIT License (see LICENSE file)
# Commands: list, install, sync, uninstall, show

# Source helpers from main bin directory
PLUGIN_BIN="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INTENT_ROOT="$(cd "$PLUGIN_BIN/../../../.." && pwd)"
INTENT_BIN="$INTENT_ROOT/bin"
source "$INTENT_BIN/intent_helpers"

# Skills source directory
SKILLS_SOURCE_DIR="$INTENT_ROOT/intent/plugins/claude/skills"

# ---- Plugin callbacks ----

PLUGIN_TYPE="skill"
PLUGIN_TYPE_CAP="Skill"
PLUGIN_TYPE_PLURAL="skills"
PLUGIN_CMD="skills"

plugin_get_manifest_path() {
  echo "$HOME/.intent/skills/installed-skills.json"
}

plugin_get_source_file() {
  echo "$SKILLS_SOURCE_DIR/$1/SKILL.md"
}

plugin_is_installed() {
  [ -f "$HOME/.claude/skills/$1/SKILL.md" ]
}

plugin_copy_to_target() {
  mkdir -p "$HOME/.claude/skills/$1" && cp -r "$SKILLS_SOURCE_DIR/$1/"* "$HOME/.claude/skills/$1/"
}

plugin_remove_target() {
  rm -rf "$HOME/.claude/skills/$1"
}

plugin_checksum_target() {
  calculate_checksum "$HOME/.claude/skills/$1/SKILL.md"
}

plugin_get_available_names() {
  local s=""
  if [ -d "$SKILLS_SOURCE_DIR" ]; then
    for d in "$SKILLS_SOURCE_DIR"/*/; do
      [ -f "${d}SKILL.md" ] && s="$s $(basename "$d")"
    done
  fi
  echo "$s"
}

plugin_manifest_extra() {
  echo ""
}

# Source shared plugin logic (install, sync, uninstall, manifest ops)
source "$PLUGIN_BIN/../lib/claude_plugin_helpers.sh"

# ---- Skill-specific functions ----

# Show help
intent_claude_skills_help() {
  cat << EOF
Usage: intent claude skills <command> [options]

Manage Claude Code skills for Intent projects.

Skills are always-on enforcement rules installed into .claude/skills/ that
shape code as it is generated, complementing subagents which review after
the fact.

Commands:
  list        List available and installed skills (-v for details)
  install     Install skill(s) to Claude configuration
  sync        Sync installed skills with latest versions
  uninstall   Remove Intent-managed skills
  show        Display detailed skill information

Examples:
  intent claude skills list                    # Show all skills
  intent claude skills list -v                 # Show full descriptions
  intent claude skills install intent-elixir-essentials  # Install a skill
  intent claude skills install --all           # Install all available skills
  intent claude skills sync                    # Update modified skills

For help on a specific command:
  intent help claude skills <command>
EOF
}

# Helper: Extract description from a SKILL.md file
# Handles both frontmatter format and legacy plain-markdown format
get_skill_description() {
  local file="$1"
  if head -1 "$file" | grep -q '^---$'; then
    # Frontmatter: extract description field
    grep '^description:' "$file" | head -1 | sed 's/^description: *//; s/^["'"'"']//; s/["'"'"']$//'
  else
    # Legacy: line 3
    sed -n '3p' "$file"
  fi
}

# Helper: Extract title from a SKILL.md file
# Handles both frontmatter format and legacy plain-markdown format
get_skill_title() {
  local file="$1"
  if head -1 "$file" | grep -q '^---$'; then
    # Frontmatter: find first H1 after closing ---
    sed -n '/^---$/,/^---$/d; /^# /{ s/^# //; p; q; }' "$file"
  else
    # Legacy: first line
    head -1 "$file" | sed 's/^# //'
  fi
}

# List available and installed skills
intent_claude_skills_list() {
  echo "Available Skills:"
  echo ""

  local skills
  skills=$(plugin_get_available_names)

  if [ -z "$skills" ]; then
    echo "  No skills found in $SKILLS_SOURCE_DIR"
    return 0
  fi

  local term_width
  term_width=$(get_terminal_width)

  # Layout: "  " (2) + skill (30) + " - " (3) = 35 left, status right-aligned
  local desc_width=$(( term_width - 35 - 16 ))
  [ "$desc_width" -lt 20 ] && desc_width=20

  # Parse --verbose flag
  local verbose=false
  while [ $# -gt 0 ]; do
    case "$1" in
      -v|--verbose) verbose=true; shift ;;
      *) shift ;;
    esac
  done

  for skill in $skills; do
    local skill_file="$SKILLS_SOURCE_DIR/$skill/SKILL.md"
    local status=""

    if plugin_is_installed "$skill"; then
      status="[INSTALLED]"
    else
      status="[NOT INSTALLED]"
    fi

    # Build left side and compute padding to right-align status
    # Using ${#var} (char count) avoids multi-byte printf padding bugs
    if [ "$verbose" = true ]; then
      local full_desc left pad
      full_desc=$(get_skill_description "$skill_file" 2>/dev/null)
      [ -z "$full_desc" ] && full_desc="No description"
      left="$(printf '%-30s' "$skill")"
      pad=$(( term_width - 2 - ${#left} - ${#status} ))
      [ "$pad" -lt 1 ] && pad=1
      printf "  %s%*s%s\n" "$left" "$pad" "" "$status"
      printf "    %s\n\n" "$full_desc"
    else
      local description full_desc left pad
      full_desc=$(get_skill_description "$skill_file" 2>/dev/null)
      if [ -z "$full_desc" ]; then
        description="No description"
      elif [ ${#full_desc} -le $desc_width ]; then
        description="$full_desc"
      else
        description="${full_desc:0:$((desc_width - 3))}"
        description="${description% *}..."
      fi

      left="$(printf '%-30s' "$skill") - $description"
      pad=$(( term_width - 2 - ${#left} - ${#status} ))
      [ "$pad" -lt 1 ] && pad=1
      printf "  %s%*s%s\n" "$left" "$pad" "" "$status"
    fi
  done

  # Check for Claude installation
  if [ ! -d "$HOME/.claude" ]; then
    echo ""
    echo "Note: Claude Code not detected. Install Claude Code to use skills."
  fi
}

# Show detailed skill information
intent_claude_skills_show() {
  if [ "$#" -eq 0 ]; then
    echo "Error: Skill name required"
    echo "Usage: intent claude skills show <skill-name>"
    return 1
  fi

  local skill_name="$1"

  # Check if skill source exists
  local source_dir="$SKILLS_SOURCE_DIR/$skill_name"
  local source_file="$source_dir/SKILL.md"

  if [ ! -f "$source_file" ]; then
    echo "Error: Skill '$skill_name' not found"
    return 1
  fi

  # Extract title and description
  local title
  title=$(get_skill_title "$source_file")
  local description
  description=$(get_skill_description "$source_file")

  # Check installation status
  local status="NOT INSTALLED"
  if plugin_is_installed "$skill_name"; then
    status="INSTALLED"
  fi

  # Display skill information
  echo "Skill: $skill_name"
  echo "Title: $title"
  echo "Description: $description"
  echo "Status: $status"
  echo "Source: $source_file"

  # Show installation info
  if [ "$status" = "INSTALLED" ]; then
    local manifest_file
    manifest_file="$(plugin_get_manifest_path)"

    if [ -f "$manifest_file" ] && command -v jq >/dev/null 2>&1; then
      local installed_info
      installed_info=$(jq -r ".installed[] | select(.name == \"$skill_name\")" "$manifest_file" 2>/dev/null)
      if [ -n "$installed_info" ]; then
        local installed_at
        installed_at=$(echo "$installed_info" | jq -r '.installed_at // "Unknown"')
        echo "Installed: $installed_at"
        echo "Location: $HOME/.claude/skills/$skill_name/SKILL.md"
      fi
    fi
  fi

  # Show content
  echo ""
  echo "Content:"
  echo "---"
  cat "$source_file"
  echo ""
  echo "---"

  if [ "$status" != "INSTALLED" ]; then
    echo ""
    echo "To install: intent claude skills install $skill_name"
  fi
}

# Route commands - only run if script is executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  case "$1" in
    list)
      shift
      intent_claude_skills_list "$@"
      ;;
    install)
      shift
      plugin_install "$@"
      ;;
    sync)
      shift
      plugin_sync "$@"
      ;;
    uninstall)
      shift
      plugin_uninstall "$@"
      ;;
    show)
      shift
      intent_claude_skills_show "$@"
      ;;
    ""|help|-h|--help)
      intent_claude_skills_help
      ;;
    *)
      echo "Error: Unknown command 'intent claude skills $1'"
      echo "Run 'intent claude skills help' for usage"
      exit 1
      ;;
  esac
fi
