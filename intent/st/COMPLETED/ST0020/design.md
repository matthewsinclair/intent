# Design - ST0020: Modernizing Intent's Elixir Support for Agentic Coding

## Approach

Layered enforcement architecture: skills for proactive code shaping, subagents for reactive review, reference docs for deep consultation.

## Design Decisions

### 1. Skills vs Subagents — Complementary, Not Competing

| Dimension      | Subagents                         | Skills                          |
| -------------- | --------------------------------- | ------------------------------- |
| Context window | Separate — no main impact         | Consumes main context tokens    |
| Activation     | Explicit delegation via Task tool | Always-on or slash-command      |
| Enforcement    | Reviews after the fact            | Shapes generation in real-time  |
| Scope          | Bounded tasks (review module X)   | Ambient standards (always do Y) |

**Decision**: Keep both. Skills = "always do this". Subagents = "review/analyze this".

### 2. Three-File LLM Guidance System

Target projects get three files in `intent/llm/`:

- **AGENTS.md** — "How to work here" (tooling, setup, commands). Auto-generated by `intent agents sync`.
- **RULES.md** — "How to write code" (mandatory rules, conventions). Human-curated, never auto-modified.
- **ARCHITECTURE.md** — "How the system works" (structure, domains, decisions). Human-curated, never auto-modified.

**Decision**: `intent agents sync` updates AGENTS.md only. RULES.md and ARCHITECTURE.md are owned by humans.

### 3. Ash-First, Never Raw Ecto

All Intent-using Elixir projects use Ash. Skills teach the Ash way exclusively:

- No `mix ecto.gen.migration` — use `mix ash.codegen`
- No direct Repo calls — use domain code interfaces
- No raw Ecto.Query in web modules — use Ash.Query or code interface options
- Reference `deps/ash/usage-rules.md` as authoritative source

### 4. Rule Distillation Strategy

Current 23 rules have significant overlap:

- Rules 1-2, 7, 10-11 all cover pipe/composition
- Rules 3, 9, 13 all cover pattern matching
- Rules 14-15 both cover avoiding if/else

**Decision**: Consolidate to ~12 non-overlapping rules organized by category:

- Data Access (assertive access, struct keys)
- Control Flow (pattern matching, with expressions)
- Composition (pipes, functional composition)
- Error Handling (tagged tuples, railway)
- Code Hygiene (no debug artifacts, naming conventions)

### 5. Skill Sizing

Each skill targets <150 lines with 7-10 mandatory rules. No overlap between skills:

- `elixir-essentials` — pure language patterns (no framework)
- `ash-ecto-essentials` — database access through Ash
- `phoenix-liveview` — LiveView lifecycle and patterns

### 6. Skill Installation Infrastructure

Mirror the existing subagent architecture:

- Source: `intent/plugins/claude/skills/<name>/SKILL.md`
- Target: `.claude/skills/<name>/SKILL.md`
- Manifest: `~/.intent/skills/installed-skills.json` (SHA256 checksums)
- Commands: same verbs as subagents (list, install, sync, uninstall, show)

Factor out common install/sync logic from `intent_claude_subagents` into shared functions.

## Architecture

```
intent/plugins/claude/
├── bin/
│   ├── intent_claude_subagents    (existing)
│   └── intent_claude_skills       (NEW — WP-06)
├── subagents/elixir/
│   ├── agent.md                   (REFACTOR — WP-01)
│   ├── style.md                   (minor updates)
│   ├── antipatterns.md            (keep as-is)
│   ├── ash-ecto.md                (NEW — WP-03)
│   ├── liveview.md                (NEW — WP-04)
│   ├── testing.md                 (NEW — WP-05)
│   └── project-structure.md       (NEW — WP-08)
└── skills/
    ├── elixir-essentials/SKILL.md (NEW — WP-02)
    ├── ash-ecto-essentials/SKILL.md (NEW — WP-03)
    └── phoenix-liveview/SKILL.md  (NEW — WP-04)

intent/plugins/agents/templates/elixir/
├── AGENTS.md                      (NEW — WP-07)
├── RULES.md                       (NEW — WP-07)
└── ARCHITECTURE.md                (NEW — WP-07)
```

## Alternatives Considered

1. **Replace subagents entirely with skills** — Rejected. Skills can't do deep multi-file code review.
2. **Single monolithic elixir skill** — Rejected. Ecto rules are noise for library work; LiveView rules irrelevant for CLI tools.
3. **Implement pre-commit hooks** — Rejected. Intent is a project management tool, not a hooks manager.
4. **Copy phoenix-guide structure** — Rejected. It targets Phoenix+Ecto; Intent targets Ash-first projects.
5. **Inline antipatterns.md into agent.md** — Rejected. At 1,853 lines it's a reference corpus, not instruction content.
